# Изучаемые команды и файлы

Команды управления пользователями: useradd, userdel, usermod, chage
Команды управления группами: groupadd, groupdel, groupmod
Команды для повышения привилегий: sudo, su
Конфигурационные файлы: /etc/passwd, /etc/shadow, /etc/group, /etc/default/useradd, /etc/login.defs, /etc/sudoers


# Файлы

## /etc/passwd
В текстовом файле /etc/passwd содержится список пользователей. Каждая строка этого файла описывает одного пользователя и представляет собой запись, состоящую из семи полей, разделенных двоеточием.

```bash
daa031:x:1000:1000:daa031:/home/daa031:/bin/bash
```
1. имя  пользователя
2. зашиврованный пароль(x-означает что хэш сумма пароля хранится в /etc/shadow)
3. идентификатор пользователя
4. идентификатор основной группы пользователя
5. комментарий(GECOS)
6. путь к домашней директории
7. путь к программе которая будет запущена после входа

## /etc/shadow

Текстовый файл /etc/shadow для управления паролями пользователей. Он принадлежит пользователю root и не доступен на чтение и запись обычным пользователям. Каждая строка этого файла соответствует одному пользователю системы и представляет собой запись, состоящую из девяти полей, разделенных двоеточием. Основная функция файла /etc/shadow – хранить хэш-суммы паролей пользователей системы. Для вычисления хэш-суммы пароля должна использоваться криптографическая хэш-функция.

```bash
daa031:$y$j9T$eSmDL7Us8LB47dmdLgbZC1$XN0VFNn9ohyfjjCzaUElPSiWbdOO6HYmDB/ga6PLd76:19494:0:99999:7:::
```
1. имя  пользователя
2. $ идентификатор алгоритма хэширования $ соль $ хэш сумма
3. Дата последнего изменения пароля
4. минимальный срок действия пароля
5. максимальный срок действия пароля
6. период предупреждения
7. период бездействия пароля
8. срок действия учетной записи

## /etc/group
Пользователи объединяются в группы для более гибкого управления доступом к файлам. Пользователь должен входить как минимум в одну группу — такую группу называют основной (primary). Также пользователь может входить в несколько дополнительных (supplementary) групп. Список групп хранится в текстовом файле /etc/group. Каждая строка этого файла описывает одну группу и представляет собой запись, состоящую из четырех полей, разделенных двоеточием.

```bash
mephi:x:1003:name1,name2
```

1. Имя группы
2. Зашифрованный пароль группы
3. Идентификатор группы (GID)
4. Список имен пользователей, входящих в группу

## /etc/login.defs

## /etc/sudoers

# Командный интерфейс


## useradd
Для создания пользователя предназначена команда ``useradd``. С помощью опций команды можно явно задать каждую характеристику пользователя. Если опции не заданы, берутся значения по умолчанию из файлов ``/etc/default/useradd ``и ``/etc/login.defs``. После создания домашней директории пользователя в нее копируется содержимое директории ``/etc/skel``, в которую системный администратор может поместить файлы, которые по умолчанию должны присутствовать у каждого пользователя.  

- ``/etc/default/useradd``- ранения настроек по умолчанию, которые применяются при создании новых пользователей с помощью команды useradd. GROUP - группу по умолчанию, к которой будет добавлен новый пользователь. HOME - задает домашний каталог(GROUP=100 в файле /etc/default/useradd обычно указывает на числовой идентификатор (GID) группы, которой по умолчанию будет принадлежать новый пользователь при создании. В данном случае, 100 - это GID группы.). INACTIVE - Указывает, сколько дней новый пользователь может оставаться неактивным (не входить в систему) до того, как его учетная запись будет заблокирована. Значение по умолчанию обычно равно -1. EXPIRE -  Позволяет задать дату окончания действия учетной записи нового пользователя. Учетная запись будет блокирована после этой даты. SHELL - Задает оболочку по умолчанию для новых пользователей. SKEL - Определяет каталог с шаблонами файлов и каталогов, который будет использоваться для инициализации домашнего каталога нового пользователя. CREATE_MAIL_SPOOL - Если установлено в yes, создается почтовый ящик (spool) для пользователя по умолчанию. Если установлено в no, то почтовый ящик не создается.

- ``/etc/login.defs``  -является конфигурационным файлом, который содержит различные параметры и настройки для управления поведением учетных записей.  UID_MIN и UID_MAX: Определяют минимальный и максимальный UID (User Identifier) для пользовательских учетных записей. GID_MIN и GID_MAX: Аналогично UID_MIN и UID_MAX, но для групповых идентификаторов (GID).PASS_MAX_DAYS и PASS_MIN_DAYS: Устанавливают максимальное и минимальное количество дней, которое пользователь может держать пароль, прежде чем ему потребуется его изменить.PASS_WARN_AGE: Определяет количество дней, за которое пользователь будет предупрежден о необходимости сменить пароль до истечения срока действия текущего пароля.PASS_MIN_LEN: Устанавливает минимальную длину пароля для пользователей.LOGIN_RETRIES: Задает количество попыток входа в систему с неправильным паролем перед блокировкой учетной записи. UMASK: Устанавливает маску доступа по умолчанию для создаваемых файлов и директорий пользователей.USERGROUPS_ENAB: Управляет созданием групп с именами, совпадающими с именами пользователей, по умолчанию. Если установлено в yes, то для каждого пользователя будет создана группа с тем же именем. MAIL_DIR: Устанавливает директорию для почтовых ящиков пользователей.ENV_PATH: Определяет путь по умолчанию, который будет установлен для переменной окружения PATH при входе пользователя.ENV_ROOTPATH: Устанавливает путь по умолчанию для пользователя root.ENCRYPT_METHOD: Определяет метод, используемый для хэширования паролей. Обычно устанавливается в SHA512.SHA_CRYPT_MIN_ROUNDS и SHA_CRYPT_MAX_ROUNDS: Определяют количество раундов, используемых при хэшировании паролей в методе SHA-512. Эти параметры повышают безопасность паролей.


- ``/etc/skel`` - используется в Linux для создания домашних каталогов новых пользователей при их первом входе в систему или при создании новой учетной записи. Директория /etc/skel содержит набор файлов и каталогов, которые будут скопированы в домашние каталоги новых пользователей как начальная конфигурация. .bashrc и .bash_profile: Начальные настройки оболочки Bash для новых пользователей.
.profile: Начальные настройки оболочки Bourne-compatible для новых пользователей (если используется оболочка, совместимая с Bourne shell).
.bash_logout: Команды, выполняемые при выходе пользователя из системы.
.ssh: Каталог для SSH-ключей и настроек, если SSH используется на системе.
public_html: Каталог для веб-страниц, если используется Apache или другой веб-сервер.



Команда ``useradd`` по умолчанию создает записи для нового пользователя в трех основных файлах. Для пользователя создана новая индивидуальная группа, в которую входит только данный пользователь. Пароль пользователю по умолчанию не устанавливается, поэтому его нужно установить явно командой ``passwd``.

Для модификации пользователя используется команда ``usermod``. Ее опции в основном повторяют опции команды useradd.

Иногда пользователю требуется возможность аутентификации по паролю, но не требуется работать в командной оболочке. Например, на почтовом сервере пользователи должны иметь учетные записи, чтобы подключаться из почтовых клиентов. Тогда в качестве входной оболочки можно установить программу ``/sbin/nologin``.


## userdel 
Для удаления пользователя используется команда userdel. По умолчанию команда userdel только удаляет учетную запись пользователя, но не затрагивает его файлы. (с флагом -r чтобы кикнуть все)

## passwd

- ``passwd -e`` / ``chage -d 0`` - заставить пользователя сменить пароль при следующем входе в систему. В результате, в поле даты последнего изменения пароля будет записан 0.

- ``usermod -L(-U)`` / ``passwd -l(-u)`` - заблокировать(разблокировать) вход пользователя в систему по паролю.

После создания учетной записи пользователя в поле, где хранится хэш-сумма пароля, записан восклицательный знак, что не позволяет пользователю войти в систему без пароля. При блокировке пользователя хэш-сумма пароля не изменяется, но в начало записывается восклицательный знак. При разблокировании пользователя восклицательный знак просто удаляется. 
```bash
sudo usermod -L kikmepls
cat /etc/shadow
>kikmepls:!$6$LjBXWCaDSu
sudo usermod -U kikmepls
cat /etc/shadow
>kikmepls:$6$LjBXWCaDSu
```

## groupadd

используется для создания новой группы пользователей. Группы представляют собой организационные единицы, которые могут содержать одного или нескольких пользователей и обеспечивать управление правами доступа к файлам и ресурсам.(sudo groupadd -r -g 1000 sysgroup Создание системной группы с именем "sysgroup" и числовым идентификатором GID 1000:)

# Суперпользователь

Для повышения своих привилегий используются такие программы, как sudo, su или Polkit. Команда ``su - <username> ``позволяет войти под пользователем ``<username>``. Если имя пользователя не указано, подразумевается ``root``:
`` su -``

Команда ``sudo`` позволяет выполнить другую команду от лица суперпользователя или другого пользователя в зависимости от настроек в конфигурационном файле ``/etc/sudoers``. В отличие от su, sudo требует ввода пароля текущего пользователя, а не пользователя, от лица которого запрашивается доступ:
```bash
sudo cat /etc/shadow
# [sudo] password for <username>:
```
- Все действия с использованием sudo по умолчанию записываются в файл /var/log/secure.


# Задания

## Повышение привилегий

### su
Войдите в систему от лица обычного пользователя. Изучите своё окружение, выполнив следующие команды:

```bash
id
pwd
echo $HOME
echo $PATH
```
-  ``su - daa`` перейти на пользоваетля daa

результат:
```bash
[user2@localhost ~]$ id
uid=1002(user2) gid=1002(user2) groups=1002(user2) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
[user2@localhost ~]$ pwd
/home/user2
[user2@localhost ~]$ echo $HOME
/home/user2
[user2@localhost ~]$ echo $PATH
/home/user2/.local/bin:/home/user2/bin:/usr/local/bin:/usr/bin:/usr/local/sbin:/usr/sbin
```
Повысьте свои привилегии, сменив пользователя на root. Снова изучите своё окружение.

```bash
[user2@localhost ~]$ su
Password: 
[root@localhost user2]# id
uid=0(root) gid=0(root) groups=0(root) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
[root@localhost user2]# pwd
/home/user2
[root@localhost user2]# 
[root@localhost user2]# echo $home

[root@localhost user2]# echo $HOME
/root
[root@localhost user2]# echo $PATH
/root/.local/bin:/root/bin:/home/user2/.local/bin:/home/user2/bin:/usr/local/bin:/usr/bin:/usr/local/sbin:/usr/sbin
[root@localhost user2]# exit
exit
[user2@localhost ~]$ 
```

### sudo
Войдите в систему от лица обычного пользователя. Попробуйте вывести последние 5 строк файла /var/log/messages. Воспользуйтесь sudo, чтобы решить задачу.

```bash
[user2@localhost ~]$ tail -n 5 /var/log/messages
tail: cannot open '/var/log/messages' for reading: Permission denied
[user2@localhost ~]$ sudo tail -n 5 /var/log/messages

We trust you have received the usual lecture from the local System
Administrator. It usually boils down to these three things:

    #1) Respect the privacy of others.
    #2) Think before you type.
    #3) With great power comes great responsibility.

[sudo] password for user2: 
user2 is not in the sudoers file.  This incident will be reported.
[user2@localhost ~]$ sudo tail -n 5 /var/log/messages
[sudo] password for user2: 
Sorry, try again.
[sudo] password for user2: 
user2 is not in the sudoers file.  This incident will be reported.
[user2@localhost ~]$ su
Password: 
[root@localhost user2]# tail -n 5 /var/log/messages
Oct  5 22:08:19 localhost systemd[1]: Started Hostname Service.
Oct  5 22:08:49 localhost systemd[1]: systemd-hostnamed.service: Deactivated successfully.
Oct  5 22:11:03 localhost su[1658]: FAILED SU (to root) user2 on pts/0
Oct  5 22:11:07 localhost su[1661]: (to root) user2 on pts/0
Oct  5 22:17:18 localhost su[1695]: (to root) user2 on pts/0
```


Сделайте резервную копию файла /etc/motd, назовите её /etc/motdOLD. Попробуйте выполнить
(Файл /etc/motd (Message Of The Day) содержит текстовое сообщение, которое отображается при входе в систему через командную строку или терминал.)
```bash
[user2@localhost etc]$ sudo echo "Welcome to Linux!" >> /etc/motd
-bash: /etc/motd: Permission denied
[user2@localhost etc]$ sudo echo "Welcome to Linux!" >> /etc/motd
-bash: /etc/motd: Permission denied
[user2@localhost etc]$ su
Password: 
[root@localhost etc]# sudo echo "Welcome to Linux!" >> /etc/motd
[root@localhost etc]# cat motd
Welcome to Linux!
[root@localhost etc]# reboot
[root@localhost etc]# Connection to 192.168.3.35 closed by remote host.
Connection to 192.168.3.35 closed.
[daa031@fedora .ssh]$ ssh rocky 
Welcome to Linux!
Last login: Thu Oct  5 20:59:38 2023 from 192.168.3.4
[daa@localhost ~]$ 
```
- объяснение почему. sudo применяется к команде echo, но не к самому оператору >> , который выполняет перенаправление вывода в файл /etc/motd (решение ``echo "Welcome to Linux!" | sudo tee -a /etc/motd
``) (tee позволяет выполнить операцию записи с правами суперпользователя, а флаг -a используется для добавления текста в конец файла без перезаписи его содержимого.)

# Изучение конфигурационных файлов

## /etc/passwd

В качестве примера работы с файлом /etc/passwd рассмотрим shell-скрипт, который выводит на экран информацию о пользователях, у которых в качестве оболочки установлен Bash. Для разбиения записей на отдельные поля используется тот факт, что поля разделяются символом :. Поэтому если переопределить переменную IFS (Internal Field Separator), Bash будет читать отдельные поля, как отдельные слова, разделенные символом-разделителем:

```bash
grep 'bash$' /etc/passwd |
while IFS=: read user passwd uid gid name homedir shell
do
    printf "%16s: %s\n" \
        User "$user" \
        Password "$passwd" \
        "User ID" "$uid" \
        "Group ID" "$gid" \
        Name "$name" \
        "Home directory" "$homedir" \
        Shell "$shell"
    echo
done
```

## /etc/shadow
Предположим, что сегодня 31 января, и в системе создан пользователь, который будет работать над проектом в течение шести месяцев (180 дней). Команда date позволяет вычислить дату, которая наступит через определенное количество дней после текущего дня. Срок действия учетной записи для нового пользователя можно ограничить 180 днями. Пароль требуется менять не реже, чем каждые три месяца (90 дней). Минимальный срок действия пароля не установлен. За пять дней до обязательной смены пароля пользователю начнут выдаваться предупреждения. Если пользователь не поменяет свой пароль, то в течение 10 дней он сможет войти в систему со старым паролем и установить новый пароль. Команда chage -l выводит текущие настройки пароля пользователя.

```bash
date
# Вывод: Mon 31 Jan 2022 02:50:12 PM MSK

date -d +180days +%Y-%m-%d
# Вывод: 2022-07-30

sudo chage -E $(date -d +180days +%Y-%m-%d) ivan
# Нет вывода

sudo chage -m 0 -M 90 -W 5 -I 10 ivan
# Нет вывода

sudo chage -l ivan
# Вывод:
# Last password change                              : Jan 31, 2022
# Password expires                                  : May 01, 2022
# Password inactive                                 : May 11, 2022
# Account expires                                   : Jul 30, 2022
# Minimum number of days between password change    : 0
# Maximum number of days between password change    : 90
# Number of days of warning before password expires : 5

sudo grep ivan /etc/shadow
# Вывод: ivan:$6$ZjdXqIs4BlbjqkBs$7oRI476rdxWEr-iysR0UYScdvaLrHO2uq9msYpVxnxeO0zuaeDTvpmfedb8oLC8kDBz9FPrrzRLn70y9//f06x.:19023:0:90:5:10:19203:
```

# Создание пользователя

## Вручную
Так как информация о пользователе хранится в простых текстовых файлах, управлять учетными записями можно и вручную. Для этого необходимо выполнить следующие действия:

1. Выбрать отличительные характеристики пользователя: логическое имя, идентификатор пользователя UID, идентификатор группы пользователя GID.
2. Создать запись в /etc/passwd.
3. Создать запись в /etc/group.
4. Создать домашнюю директорию пользователя по шаблону /home/<username>
5. Скопировать в домашнюю директорию файлы, которые должны присутствовать у пользователя и, в том числе, выполняться при входе пользователя в систему.
6. Изменить владельца и группу домашней директории со всем ее содержимым на вновь созданного пользователя и его группу. При необходимости изменить права к домашней директории.
7. Создать запись в /etc/shadow в соответствии с политикой безопасности организации по управлению паролями (например, как часто надо пользователю менять свой пароль).
8. Установить пользователю пароль.

Подсказка

Для создания записи в /etc/shadow можно воспользоваться командой openssl passwd.
```bash
[root@localhost user2]# nano /etc/passwd
[root@localhost user2]# nano /etc/group
[root@localhost home]# mkdir user_lab
[root@localhost home]# ls
daa  kikmepls  user2  user_lab
[root@localhost home]# pwd
/home
[root@localhost home]# 

```
Проделайте эти шаги и создайте пользователя вручную.
